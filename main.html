<!doctype html>
<html>
  <head>
    <script type="text/javascript" src="https://www.fofx.co/comp/comp.js"></script>
    <script type="text/javascript" src="https://restonlimousine.github.io/staff/xlsx.js"></script>
  </head>
  <body>
    <h4>Upload Santa Cruz Export</h4>
    <input type="file" id="upload-santa-cruz">
    <h4>Upload Samsara Export</h4>
    <input type="file" id="upload-samsara">
    <script type="text/plain" data-comp-src="https://raw.githubusercontent.com/fofx-software/comp/master/comp/comp/core.cmp.clj">
      {:ns main
       :require [[element.core :as el :src "https://raw.githubusercontent.com/fofx-software/element/master/core.cmp.clj"]]}
      
      (def files (atom {}))
      
      (defn get-scr-headers
        [[headers]]
        (vector
          (get-key headers "DispatchDriverName")
          (get-key headers "PickupDateTime")))
      
      (defn compare-files
        [{sms "upload-samsara" scr "upload-santa-cruz"}]
        (let [[driver-name pickup-time] (get-scr-headers src)]
          (comp/pr [driver-name pickup-time])))
      
      (defn make-reader
        [which]
        (let [reader (new js/FileReader)]
          (.addEventListener reader "loadend"
            (fn [e]
              (let [result (new js/Uint8Array (.-result reader))
                    book (.read js/XLSX result (object "type" "array"))
                    first-sheet (-> book .-SheetNames (aget 0))
                    sheet (-> book .-Sheets (aget first-sheet))
                    opts (object "header"  1)
                    json (-> js/XLSX .-utils (.sheet_to_json sheet opts))
                    files (swap! files assoc which json)]
                (if (= (count files) 2) (compare-files files)))))
          reader))
      
      (doseq [id ["upload-samsara" "upload-santa-cruz"]]
        (let [reader (make-reader id)
              input (el/query {:id id})]
          (.addEventListener input "change"
            (fn [e]
              (.readAsArrayBuffer reader (aget (.-files input) 0))))))
      
    </script>
  </body>
</html>
